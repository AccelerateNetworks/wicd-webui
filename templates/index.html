<!DOCTYPE html>
<html lang="en">
<head>
	<title>wicd-webui</title>	 
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

	<link rel="stylesheet" href="{{ url_for('static',filename='css/bootstrap.min.css') }}">
	<link rel="stylesheet" href="{{ url_for('static',filename='css/bootstrap-theme.min.css') }}">
</head>

<body onload="current_network(); list_networks();">
	<div class="container" style="margin-top:10px;">
		<div class="panel panel-default">
			<!-- Default panel contents -->
			<div class="panel-heading text-center"><a href="https://github.com/fopina/wicd-webui">wicd WebUI</a></div>
			<div class="panel-body text-center" id="current_network">
				<p></p>
			</div>
			<!-- Table -->
			<div class="table-responsive">
				<table class="table text-center" id="network-table">
					<thead>
						<tr>
							<th class="text-center">ESSID</th>
							<th class="text-center">Encryption</th>
							<th class="text-center">Quality</th>
							<th class="text-center"><a href="javascript:scan_networks();"><span class="glyphicon glyphicon-refresh"></span></a></th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<script src="{{ url_for('static',filename='js/jquery.min.js') }}"></script>
	<script src="{{ url_for('static',filename='js/bootstrap.min.js') }}"></script>
	<script>

	var statusModal = (function () {
		var mainDiv = $('<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel" aria-hidden="true" data-keyboard="false" data-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title" id="statusModalLabel"></h4></div><div class="modal-body" id="statusModalText"></div></div></div></div>')
		var textDiv = $('#statusModalText', mainDiv);
		var labelDiv = $('#statusModalLabel', mainDiv);
		var closeButton = $('.close', mainDiv);
		return {
			show: function() {
				textDiv.text('Processing...');
				labelDiv.text('Please wait');
				closeButton.hide();
				mainDiv.modal();
			},
			hide: function () {
				mainDiv.modal('hide');
			},
			text: function (text) {
				textDiv.text(text);
			},
			label: function (text) {
				labelDiv.text(text);
			},
			closeable: function() {
				closeButton.show();
			},
		};
	})();

	function refresh_networks(data) {
		
		$('#network-table>tbody').remove();
		var tbody = $('<tbody/>');
		var known
		$.each( data['data'], function( key, val ) {
			if (val["known"]) known = "<span class=\"glyphicon glyphicon-ok\">";
			else known = "";
			$("<tr/>", { html: "\
				<td>" + val["essid"] + "</td>\
				<td>" + val["encryption"] + known + "</td>\
				<td>" + val["quality"] + "%</td>\
				<td>\
				<a href=\"javascript:connect_to_network(" + val["network_id"] + ");\">\
				<span class=\"glyphicon glyphicon-log-in\">\
				</a>\
				&nbsp;\
				<a href=\"javascript:connect_to_network(" + val["network_id"] + ");\">\
				<span class=\"glyphicon glyphicon-cog\">\
				</a>\
				</td>\
				"}).appendTo(tbody);
		});
		tbody.appendTo("#network-table");
		statusModal.hide();
	};

	function list_networks() {
		statusModal.show();
		statusModal.text('Listing networks...')
		$.getJSON( "list", refresh_networks );
	};

	function scan_networks() {
		statusModal.show();
		statusModal.text('Scanning networks...')
		$.getJSON( "scan", refresh_networks );
	};

	function connect_to_network(network_id) {
		statusModal.show();
		statusModal.text('Connecting...')
		$.getJSON( "connect/" + network_id, function(data) {
			statusModal.label('Please wait (' + data['data'] + ')');
			statusModal.text('Connecting to ' + data['data'] + '...');
			watch_connection_status();
		} );
	};

	function watch_connection_status() {
		$.getJSON( "status", function(data) {
			connecting = data['data'][0];
			message = data['data'][2];
			statusModal.text(message);
			if (connecting) setTimeout(watch_connection_status, 1000);
			else {
				statusModal.closeable();
				current_network();
			};
		});
	}

	function disconnect_network() {
		statusModal.show();
		statusModal.text('Disconnecting...')
		$.getJSON( "disconnect", function(data) {
			$('#current_network>p').text("Currently not connected to any network");
			statusModal.hide();
		} );
	};

	function current_network() {
		$.getJSON( "current", function(data) {
			$('#current_network>p').remove();
			var newp = $('<p/>');
			if ($.isEmptyObject(data['data']))
				newp.text("Currently not connected to any network");
			else {
				newp.text('Connected to ')
				newp.append($('<i/>').text('"' + data['data']['network'] + '"'));
				newp.append(document.createTextNode(' at '));
				newp.append($('<i/>').text(data['data']['quality'] + '%'));
				newp.append(document.createTextNode(' (IP: '));
					newp.append($('<i/>').text(data['data']['ip']));
					newp.append(document.createTextNode(')'));
					newp.append('\
						<a href=\"javascript:disconnect_network();\">\
						<span class=\"glyphicon glyphicon-log-out\">\
						</a>');
				}
				newp.appendTo("#current_network");
			});
	};
	</script>
</body>
</html>